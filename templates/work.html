<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Archive</title>
    <style>
        /* Minimal styling to enforce serif font and meet new requirements */
        body {
            font-family: serif;
            margin: 20px;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Prevent horizontal scroll globally */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Hide scrollbars but keep functionality */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        
        *::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        /* Style for centering the content column */
        .content-wrapper {
            max-width: 600px; /* Sets a readable maximum width for the column */
            margin: 0 auto; /* Centers the div horizontally */
            width: 100%; /* Ensures it uses available space up to max-width */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        /* Ensure year headings are clearly visible against a white background */
        .project-archive h2 {
            color: #000;
        }
        
        /* Layout for the Header: Sticker and Navigation on one line */
        .header-container {
            display: flex;
            align-items: center; /* Vertically centers the nav and sticker */
            gap: 20px; /* Space between sticker and nav */
            margin-bottom: 30px; /* Add space below the entire header block */
        }

        /* Remove default list styling for the archive */
        .project-archive ul {
            list-style: none;
            padding-left: 0;
            margin-top: 5px; /* Reduce space below year */
        }
        
        /* Apply sans-serif font to project names (list items) and enable Flexbox for date positioning */
        .project-archive li {
            font-family: sans-serif;
            margin-bottom: 4px;
            display: flex; /* Enables horizontal arrangement */
        }

        /* The link wrapping the project name, ensures full name is displayed and behaves well in flex layout */
        .project-archive li > a {
            color: inherit;
            text-decoration: none;
            white-space: nowrap; /* Forces text onto a single line */
            flex-shrink: 0;      /* Prevents the name from shrinking or being cut off */
            font-family: serif;  /* Change font to serif */
            transform: scaleY(1.2); /* Add vertical scaling */
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* The element that fills the space with dots */
        .dot-filler {
            /* Takes up all remaining space between name and date */
            flex-grow: 1; 
            /* Ensures the dots don't wrap and allows us to align them */
            white-space: nowrap; 
            overflow: hidden; /* Dots can be truncated if necessary, as they are padding */
            margin: 0 8px; /* Small buffer space around the dots */
            /* Ensures dots are left-aligned next to the project name */
            text-align: left; 
        }
        
        /* Style for the date text to ensure it doesn't wrap */
        .project-date {
            white-space: nowrap; 
            /* Color set dynamically by JavaScript */
        }

        /* Ensure navigation links appear next to each other and remove underline */
        nav {
            display: flex;
            gap: 15px; 
            /* Push the navigation to the far right */
            margin-left: auto;
        }
        
        /* Custom underline styling */
        nav a {
            text-decoration: none; /* Remove default underline */
            color: initial; /* Default link color (same as year/body text) */
            transition: color 0.1s;
        }
        
        /* Apply wavy underline, inheriting the dynamic date color */
        nav a:hover {
            color: var(--date-color); /* Change text color to dynamic date color */
            text-decoration: underline wavy; 
            text-decoration-color: var(--date-color); /* Change underline color to dynamic date color */
            text-underline-offset: 4px; /* Slight offset for readability */
            cursor: pointer;
        }

        /* Styling for the sticker (Static - no transitions/animations) */
        .pixel-sticker {
            display: block;
            transform-origin: center; /* Ensures rotation is around the sticker's center */
        }

        /* Mobile Responsive Styles */
        @media screen and (max-width: 768px) {
            body {
                margin: 10px;
                padding: 0;
            }

            .content-wrapper {
                max-width: 100%;
                width: calc(100vw - 25px);
                padding: 0;
                margin: 0 auto;
                box-sizing: border-box;
            }

            .header-container {
                margin-bottom: 25px;
                gap: 15px;
                width: 100%;
                box-sizing: border-box;
            }

            #archive h2 {
                font-size: 1em;
                margin-top: 35px;
                margin-bottom: 15px;
            }

            #archive li {
                width: 100%;
                box-sizing: border-box;
                max-width: 100%;
            }

            #archive li > a,
            #archive li > span {
                font-size: 0.95em;
                white-space: normal;
                word-wrap: break-word;
                max-width: 70%;
            }

            .article-date {
                font-size: 0.85em;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .dot-filler {
                margin: 0 5px;
                min-width: 10px;
                flex-shrink: 1;
            }
        }

        /* Extra small screens (phones in portrait) */
        @media screen and (max-width: 480px) {
            body {
                margin: 5px;
                padding: 0;
            }

            .content-wrapper {
                padding: 0;
                width: calc(100vw - 25px);
                max-width: 100%;
            }

            .header-container {
                margin-bottom: 20px;
                gap: 10px;
            }

            nav {
                gap: 8px;
                flex-wrap: wrap;
            }

            #archive h2 {
                font-size: 0.95em;
                margin-top: 30px;
                margin-bottom: 12px;
            }

            #archive li {
                padding: 3px 0;
            }

            #archive li > a,
            #archive li > span {
                font-size: 0.9em;
                max-width: 65%;
            }

            .article-date {
                font-size: 0.8em;
            }

            .dot-filler {
                margin: 0 4px;
            }
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <header class="header-container">
            <!-- 
                2D Sticker container. Reduced size to 32x32 for pixelated look.
                The content is a procedural geometric figure dynamically inserted by JavaScript.
            -->
            <svg id="random-sticker-svg" class="pixel-sticker" width="32" height="32" viewBox="0 0 4 4">
                <!-- Fallback content, overwritten by JS -->
            </svg>

            <!-- Navigation (moved to the far right) -->
            <nav>
                <a href="/">home</a>
                <a href="/work">work</a>
                <a href="/contact">contact</a>
            </nav>
        </header>

        <!-- Project Archive Content (now dynamically generated from articles) -->
        <div class="project-archive" id="archive-container">
            <!-- Content will be dynamically generated by JavaScript -->
            
            <!-- Hidden element for measuring dot width -->
            <span id="dot-measure" style="visibility: hidden; position: absolute; font-family: sans-serif; height: 0; overflow: hidden; white-space: nowrap;">.</span>
        </div>
    </div>
    
    <script>
        /**
         * Project Data Dictionary: Interface for editing archive content.
         * Format: { name: "Project Title", date: "MMM, DD", slug: "project-slug" }
         */
        const projectData = {
        };

        // Global variable to store the calculated width of a single dot character
        let dotWidth = 0;
        let stickerFigureColor = '';

        // --- Color Generation Utilities (Updated for Triadic Colors) ---
        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            const k = n => (n + h / 30) % 12;
            const a = s * Math.min(l, 1 - l);
            const f = n =>
                l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
            const toHex = val => Math.round(255 * val).toString(16).padStart(2, '0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }

        /**
         * Generates three bold, bright colors forming a Triadic Color Scheme.
         * Returns an array [C1, C2, C3].
         */
        function generateBoldTriadicColors() {
            const H1 = Math.floor(Math.random() * 360);
            const S = Math.floor(Math.random() * 20) + 80; // 80-100% Saturation (Bold)
            const L = Math.floor(Math.random() * 10) + 55; // 55-65% Lightness (Bright)

            const C1 = hslToHex(H1, S, L);
            const H2 = (H1 + 120) % 360;
            const C2 = hslToHex(H2, S, L);
            const H3 = (H1 + 240) % 360; // Third color in the triad
            const C3 = hslToHex(H3, S, L);

            return [C1, C2, C3];
        }
        
        // --- Sticker Generation Logic ---
        function getRandomFigure() {
            const colors = generateBoldTriadicColors();
            // Randomly select two colors for the sticker (C_A and C_B)
            const indexA = Math.floor(Math.random() * 3);
            let indexB = (indexA + 1) % 3; // Ensure C_B is different from C_A
            if (Math.random() < 0.5) indexB = (indexA + 2) % 3; // 50% chance of picking the third color

            const stickerColors = [colors[indexA], colors[indexB]];
            
            // C3 is now the dedicated date color
            const dateColor = colors[2]; 

            const P1 = stickerColors[0];
            const P2 = stickerColors[1];
            
            stickerFigureColor = dateColor; // Set the C3 color globally for dates

            const patternTypes = [
                () => `<polygon points="0,0 4,4 4,0" fill="${P1}" /><polygon points="0,0 4,4 0,4" fill="${P2}" />`,
                () => `<rect x="0" y="0" width="2" height="2" fill="${P1}" /><rect x="2" y="0" width="2" height="2" fill="${P2}" /><rect x="0" y="2" width="2" height="2" fill="${P2}" /><rect x="2" y="2" width="2" height="2" fill="${P1}" />`,
                () => `<rect x="0" y="0" width="2" height="4" fill="${P1}" /><rect x="2" y="0" width="2" height="4" fill="${P2}" />`,
                () => `<rect x="0" y="0" width="4" height="4" fill="${P1}" />`,
                () => `<circle cx="2" cy="2" r="2" fill="${P1}" />`,
                () => `<polygon points="2,0 4,4 0,4" fill="${P1}" />`,
                () => {
                    const innerShapes = [`<rect x="1" y="1" width="2" height="2" fill="${P2}" />`, `<circle cx="2" cy="2" r="1" fill="${P2}" />`, `<polygon points="2,1 3.5,3.5 0.5,3.5" fill="${P2}" />`];
                    return `<rect x="0" y="0" width="4" height="4" fill="${P1}" />${innerShapes[Math.floor(Math.random() * innerShapes.length)]}`;
                }
            ];
            return patternTypes[Math.floor(Math.random() * patternTypes.length)]();
        }

        function randomizeSticker(randomizeFigure = true) {
            const svgContainer = document.getElementById('random-sticker-svg');
            
            if (randomizeFigure) {
                // 1. Generate the complex randomized figure SVG and set the global date color
                svgContainer.innerHTML = getRandomFigure();

                // 2. Randomize Orientation (0, 90, 180, 270 degrees)
                const orientations = [0, 90, 180, 270];
                const randomRotation = orientations[Math.floor(Math.random() * orientations.length)];
                svgContainer.style.transform = `rotate(${randomRotation}deg)`;
            }

            // Set CSS Variable for use in the dynamic underline
            document.documentElement.style.setProperty('--date-color', stickerFigureColor);

            // 3. Render the archive list with correct dot count and color
            renderArchive();
        }
        
        // --- Dynamic Dot Rendering Logic ---
        
        function calculateDotWidth() {
            const measureSpan = document.getElementById('dot-measure');
            if (measureSpan) {
                measureSpan.textContent = '.';
                dotWidth = measureSpan.offsetWidth;
            }
        }

        function renderArchive() {
            if (dotWidth === 0) return;

            const wrapper = document.querySelector('.content-wrapper');
            const container = document.getElementById('archive-container');
            const measureSpan = document.getElementById('dot-measure');

            // Save measureSpan, clear container, re-append measureSpan
            if (measureSpan) container.removeChild(measureSpan);
            container.innerHTML = '';
            if (measureSpan) container.appendChild(measureSpan);

            const wrapperWidth = wrapper.clientWidth;
            const dateColor = stickerFigureColor || 'blue';

            // Merge articles from server with hardcoded projects
            const mergedData = { ...projectData };
            
            // Add articles from the server
            {% if articles_by_year %}
                {% for year, articles in articles_by_year.items() %}
                if (!mergedData[{{ year }}]) {
                    mergedData[{{ year }}] = [];
                }
                {% for article in articles %}
                mergedData[{{ year }}].push({
                    name: "{{ article.title|lower }}",
                    date: "{{ article.date_str }}",
                    slug: "{{ article.slug }}"
                });
                {% endfor %}
                {% endfor %}
            {% endif %}

            // Sort years in descending order
            const sortedYears = Object.keys(mergedData).sort((a, b) => b - a);

            sortedYears.forEach(year => {
                // Create Year Heading
                const h2 = document.createElement('h2');
                h2.innerText = year;
                container.insertBefore(h2, measureSpan);

                // Create Unordered List
                const ul = document.createElement('ul');
                ul.id = `archive-${year}`;
                container.insertBefore(ul, measureSpan);

                mergedData[year].forEach(item => {
                    const li = document.createElement('li');
                    
                    // Project Name and Link
                    const nameLink = document.createElement('a');
                    nameLink.href = item.slug.startsWith('/') ? item.slug : `/article/${item.slug}`;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.innerText = item.name.toLowerCase();
                    nameLink.appendChild(nameSpan);
                    
                    const dateSpan = document.createElement('span');
                    dateSpan.className = 'project-date';
                    dateSpan.innerText = item.date;
                    dateSpan.style.color = dateColor;

                    // Temporarily place elements to measure
                    li.appendChild(nameLink);
                    li.appendChild(dateSpan);
                    ul.appendChild(li);

                    // Measure widths
                    const nameWidth = nameLink.offsetWidth;
                    const dateWidth = dateSpan.offsetWidth;
                    const availableSpace = wrapperWidth - nameWidth - dateWidth - 16;
                    
                    let dotCount = Math.floor(availableSpace / dotWidth);
                    dotCount = Math.max(0, dotCount);
                    
                    // Create dot filler
                    const dotFiller = document.createElement('span');
                    dotFiller.className = 'dot-filler';
                    dotFiller.innerText = '.'.repeat(dotCount);

                    // Reconstruct LI
                    li.innerHTML = '';
                    li.appendChild(nameLink);
                    li.appendChild(dotFiller);
                    li.appendChild(dateSpan);
                });
            });
        }

        // Variable to track width for resize optimization
        let lastKnownWidth = 0;

        function handleResize() {
            const currentWidth = document.querySelector('.content-wrapper').clientWidth;
            if (Math.abs(currentWidth - lastKnownWidth) > 5) {
                lastKnownWidth = currentWidth;
                renderArchive();
            }
        }

        // Initialization function
        window.onload = function() {
            calculateDotWidth();
            randomizeSticker(true);
            renderArchive();
            lastKnownWidth = document.querySelector('.content-wrapper').clientWidth;
            
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(handleResize, 100);
            });
        };
    </script>
</body>
</html>